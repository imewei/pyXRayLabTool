name: Optimized CI/CD

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: 1
  PYTHONDONTWRITEBYTECODE: 1
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  PIP_NO_PYTHON_VERSION_WARNING: 1
  PIP_ROOT_USER_ACTION: ignore

  # Performance optimizations for CI
  PYTHONHASHSEED: 0
  PYTHONIOENCODING: utf-8
  OMP_NUM_THREADS: 2
  MKL_NUM_THREADS: 2
  OPENBLAS_NUM_THREADS: 2

  # Memory and resource management
  UV_SYSTEM_PYTHON: 1
  FORCE_COLOR: 1

  # Latest tool versions for 2025
  RUFF_VERSION: "0.13.1"
  BLACK_VERSION: "25.1.0"
  ISORT_VERSION: "6.0.1"
  MYPY_VERSION: "1.18.1"
  PYTEST_VERSION: "8.3.4"

jobs:
  # Fast feedback job - runs first for immediate developer feedback
  quick-check:
    name: Quick Check
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      should-run-full: ${{ steps.changes.outputs.should-run-full }}
      python-files-changed: ${{ steps.changes.outputs.python-files }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # Need full history for proper change detection
        show-progress: false  # Reduce checkout noise

    - name: Detect changes
      id: changes
      run: |
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
        else
          BASE_SHA="${{ github.event.before }}"
        fi

        echo "Base SHA: $BASE_SHA"
        echo "Current SHA: ${{ github.sha }}"

        # Check if this is an initial commit or if base SHA is available
        if [[ "$BASE_SHA" == "0000000000000000000000000000000000000000" ]] || ! git cat-file -e "$BASE_SHA" 2>/dev/null; then
          echo "Initial commit or base SHA not available, running full checks"
          echo "should-run-full=true" >> $GITHUB_OUTPUT
          echo "python-files=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Get changed files
        CHANGED_FILES=$(git diff --name-only "$BASE_SHA"..."${{ github.sha }}")
        echo "Changed files:"
        echo "$CHANGED_FILES"

        # Check for Python files
        PYTHON_CHANGED=$(echo "$CHANGED_FILES" | grep -E '\.(py|pyi)$' || true)

        # Check for critical files that require full test suite
        CRITICAL_CHANGED=$(echo "$CHANGED_FILES" | grep -E '(pyproject\.toml|setup\.|requirements.*\.txt|\.github/workflows/|conftest\.py)' || true)

        if [[ -n "$PYTHON_CHANGED" ]] || [[ -n "$CRITICAL_CHANGED" ]]; then
          echo "should-run-full=true" >> $GITHUB_OUTPUT
          echo "python-files=true" >> $GITHUB_OUTPUT
        else
          echo "should-run-full=false" >> $GITHUB_OUTPUT
          echo "python-files=false" >> $GITHUB_OUTPUT
        fi

    - name: Set up Python 3.12
      if: steps.changes.outputs.python-files == 'true'
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'pyproject.toml'

    - name: Install minimal dependencies (cached)
      if: steps.changes.outputs.python-files == 'true'
      run: |
        python -m pip install --upgrade pip --quiet
        pip install ruff==${{ env.RUFF_VERSION }} --quiet --no-warn-script-location

    - name: Quick syntax check
      if: steps.changes.outputs.python-files == 'true'
      run: |
        # Fast syntax check only
        ruff check --select E9,F63,F7,F82 xraylabtool/ tests/ --output-format=github

  # Optimized linting with latest tools
  lint:
    name: Code Quality
    needs: quick-check
    if: needs.quick-check.outputs.should-run-full == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 1

    - name: Set up Python 3.12
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: |
          pyproject.toml
          .pre-commit-config.yaml

    - name: Cache pre-commit hooks
      uses: actions/cache@v4
      with:
        path: ~/.cache/pre-commit
        key: pre-commit-v5-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}-${{ env.RUFF_VERSION }}
        restore-keys: |
          pre-commit-v5-${{ runner.os }}-

    - name: Cache tool dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python3.12/site-packages
        key: tools-v5-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}-${{ env.RUFF_VERSION }}-${{ env.BLACK_VERSION }}-${{ env.MYPY_VERSION }}
        restore-keys: |
          tools-v5-${{ runner.os }}-

    - name: Install linting tools (optimized with retry)
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 5
        max_attempts: 3
        retry_on: error
        command: |
          python -m pip install --upgrade pip --quiet
          # Install tools efficiently with minimal output
          pip install --quiet --no-warn-script-location \
            ruff==${{ env.RUFF_VERSION }} \
            black==${{ env.BLACK_VERSION }} \
            isort==${{ env.ISORT_VERSION }} \
            mypy==${{ env.MYPY_VERSION }} \
            bandit[toml]==1.8.6

    - name: Run ruff (fast linting and formatting)
      run: |
        echo "::group::Ruff Format Check"
        ruff format --check --diff xraylabtool/ tests/
        echo "::endgroup::"

        echo "::group::Ruff Lint"
        ruff check xraylabtool/ tests/ --output-format=github
        echo "::endgroup::"

    - name: Run black (backup formatting check)
      run: |
        black --check --diff xraylabtool/ tests/

    - name: Run isort
      run: |
        isort --check-only --diff xraylabtool/ tests/

    - name: Run mypy
      run: |
        mypy xraylabtool/ --show-error-codes --pretty

    - name: Run bandit security check
      run: |
        bandit -r xraylabtool/ -f json -o bandit-report.json --quiet || true
        bandit -r xraylabtool/ --skip B101,B603,B110,B324 --quiet

    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: bandit-report.json
        retention-days: 7

  # Fast test execution with smart parallelization
  test:
    name: Tests
    needs: [quick-check, lint]
    if: always() && needs.quick-check.outputs.should-run-full == 'true' && (needs.lint.result == 'success' || needs.lint.result == 'skipped')
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.11', '3.12', '3.13']
        # Reduce matrix for non-critical changes
        exclude:
          - os: macos-latest
            python-version: '3.11'
          - os: windows-latest
            python-version: '3.11'

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 1

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: 'pyproject.toml'

    - name: Cache test dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python${{ matrix.python-version }}/site-packages
        key: test-deps-v5-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}-${{ env.PYTEST_VERSION }}
        restore-keys: |
          test-deps-v5-${{ runner.os }}-py${{ matrix.python-version }}-

    - name: Install dependencies (optimized with retry)
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 8
        max_attempts: 3
        retry_on: error
        command: |
          python -m pip install --upgrade pip --quiet
          # Use faster editable install
          pip install -e .[dev] pytest==${{ env.PYTEST_VERSION }} pytest-xdist --quiet --no-warn-script-location

    - name: Run tests with smart parallelization
      shell: bash
      run: |
        # Optimize worker count for CI environment
        WORKERS=$(python -c "import os; print(min(4, max(1, (os.cpu_count() or 1) // 2)))")
        echo "Running tests with $WORKERS workers (optimized for CI)"

        # Smart test execution with early termination
        if [[ "${{ matrix.os }}" == "ubuntu-latest" && "${{ matrix.python-version }}" == "3.12" ]]; then
          # Primary test run with coverage
          pytest \
            tests/unit/ tests/integration/ \
            -v \
            --cov=xraylabtool \
            --cov-report=xml \
            --cov-report=term-missing:skip-covered \
            --cov-fail-under=40 \
            --junit-xml=pytest-results.xml \
            -n $WORKERS \
            --maxfail=3 \
            --tb=short \
            --durations=10 \
            -x  # Stop on first failure for fast feedback
        else
          # Fast test execution without coverage
          pytest \
            tests/unit/ \
            -v \
            --junit-xml=pytest-results.xml \
            -n $WORKERS \
            --maxfail=2 \
            --tb=line \
            -x  # Stop on first failure
        fi

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.python-version }}
        path: |
          pytest-results.xml
          .coverage
          coverage.xml
        retention-days: 7

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # Optimized build process
  build:
    name: Build & Package
    needs: [lint, test]
    if: always() && (needs.lint.result == 'success' || needs.lint.result == 'skipped') && needs.test.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 1

    - name: Set up Python 3.12
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Cache build tools
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python3.12/site-packages
        key: build-tools-v5-${{ runner.os }}-build-twine
        restore-keys: |
          build-tools-v5-${{ runner.os }}-

    - name: Install build tools (cached with retry)
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 3
        max_attempts: 3
        retry_on: error
        command: |
          python -m pip install --upgrade pip --quiet
          pip install build==1.2.2 twine==6.0.1 --quiet --no-warn-script-location

    - name: Build package
      run: |
        python -m build

    - name: Check package integrity
      run: |
        python -m twine check dist/*

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/
        retention-days: 30

  # Fast integration tests
  integration:
    name: Integration Tests
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 6

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 1

    - name: Set up Python 3.12
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/

    - name: Install from wheel (fast)
      run: |
        python -m pip install --upgrade pip --quiet
        pip install dist/*.whl --quiet --no-warn-script-location

    - name: Test CLI functionality (comprehensive)
      run: |
        echo "🧪 Testing CLI functionality..."
        xraylabtool --version

        # Quick functionality test
        xraylabtool calc Si -e 10.0 -d 2.33 --fields energy_kev,wavelength_angstrom

        # Test error handling
        if xraylabtool calc InvalidElement -e 10.0 -d 1.0 2>/dev/null; then
          echo "❌ Expected error for invalid element"
          exit 1
        else
          echo "✅ Error handling works correctly"
        fi

    - name: Test package import (enhanced)
      run: |
        python -c "
        import xraylabtool
        from xraylabtool import calculate_xray_properties
        print('✅ Package import successful')
        print(f'Version: {xraylabtool.__version__}')

        # Quick calculation test
        result = calculate_xray_properties('Si', 10.0, 2.33)
        assert hasattr(result, 'energy_kev'), 'Missing energy_kev attribute'
        print('✅ Basic calculation test passed')
        "

  # Status check with improved reporting
  status-check:
    name: Status Check
    if: always()
    needs: [quick-check, lint, test, build, integration]
    runs-on: ubuntu-latest

    steps:
    - name: Generate comprehensive status report
      run: |
        echo "📊 OPTIMIZED CI/CD PIPELINE STATUS REPORT"
        echo "==========================================="
        echo "🕐 Run completed at: $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")"
        echo "🔗 Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""

        # Job status summary
        echo "📋 JOB STATUS SUMMARY:"
        echo "  ⚡ Quick Check: ${{ needs.quick-check.result }}"
        echo "  🔍 Code Quality: ${{ needs.lint.result }}"
        echo "  🧪 Tests: ${{ needs.test.result }}"
        echo "  📦 Build: ${{ needs.build.result }}"
        echo "  🔗 Integration: ${{ needs.integration.result }}"
        echo ""

        # Performance metrics
        echo "📈 PERFORMANCE METRICS:"
        echo "  🏃 Pipeline optimized for speed and reliability"
        echo "  🎯 Smart caching enabled for faster builds"
        echo "  🔄 Intelligent retry mechanisms active"
        echo "  ⚡ Expected total runtime: 8-12 minutes"
        echo ""

        # Determine overall status with enhanced reporting
        failed_jobs=()

        if [[ "${{ needs.quick-check.result }}" == "failure" ]]; then
          failed_jobs+=("Quick Check")
        fi
        if [[ "${{ needs.lint.result }}" == "failure" ]]; then
          failed_jobs+=("Code Quality")
        fi
        if [[ "${{ needs.test.result }}" == "failure" ]]; then
          failed_jobs+=("Tests")
        fi
        if [[ "${{ needs.build.result }}" == "failure" ]]; then
          failed_jobs+=("Build")
        fi
        if [[ "${{ needs.integration.result }}" == "failure" ]]; then
          failed_jobs+=("Integration")
        fi

        if [ ${#failed_jobs[@]} -eq 0 ]; then
          echo "🎉 SUCCESS: All pipeline stages completed successfully!"
          echo "✅ Code quality: PASSED"
          echo "✅ Test coverage: PASSED"
          echo "✅ Build integrity: PASSED"
          echo "✅ Integration tests: PASSED"
          echo ""
          echo "🚀 Ready for merge and deployment!"
          echo "📊 This optimized pipeline ensures fast, reliable CI/CD"
        else
          echo "❌ FAILURE: ${#failed_jobs[@]} stage(s) failed"
          echo "🚨 Failed stages: ${failed_jobs[*]}"
          echo ""
          echo "🔧 NEXT STEPS:"
          echo "  1. Review the failed job logs above"
          echo "  2. Fix the identified issues"
          echo "  3. Push changes to trigger re-run"
          echo "  4. The optimized pipeline will provide fast feedback"
          exit 1
        fi
